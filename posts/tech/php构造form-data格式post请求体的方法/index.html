<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³• | Lorenwe Blog</title>
<meta name=keywords content="PHP,POST,HTTP"><meta name=description content="å¼•è¨€
æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› RFC2616 çš„åŸå§‹æ ¼å¼ã€‚
åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– php://input è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚"><meta name=author content="Lorenwe"><link rel=canonical href=https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://lorenwe.eu.org/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lorenwe.eu.org/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lorenwe.eu.org/img/favicon.ico><link rel=apple-touch-icon href=https://lorenwe.eu.org/img/favicon.ico><link rel=mask-icon href=https://lorenwe.eu.org/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js></script><meta property="og:title" content="PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•"><meta property="og:description" content="å¼•è¨€
æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› RFC2616 çš„åŸå§‹æ ¼å¼ã€‚
åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– php://input è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-25T14:47:27+08:00"><meta property="article:modified_time" content="2024-09-25T14:47:27+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•"><meta name=twitter:description content="å¼•è¨€
æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› RFC2616 çš„åŸå§‹æ ¼å¼ã€‚
åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– php://input è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://lorenwe.eu.org/posts/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://lorenwe.eu.org/posts/tech/"},{"@type":"ListItem","position":3,"name":"PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•","item":"https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•","name":"PHPæ„é€ multipart\/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•","description":"å¼•è¨€ æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› RFC2616 çš„åŸå§‹æ ¼å¼ã€‚\nåœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– php://input è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚\n","keywords":["PHP","POST","HTTP"],"articleBody":"å¼•è¨€ æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› RFC2616 çš„åŸå§‹æ ¼å¼ã€‚\nåœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– php://input è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚\nStack Overflow ä¸Šçš„ç›¸å…³é—®é¢˜ç»™å‡ºçš„ è§£å†³åŠæ³• æ˜¯ä¿®æ”¹æœåŠ¡å™¨é…ç½®ï¼ŒæŠŠå‘åˆ° PHP è„šæœ¬çš„ Content-Type: multipart/form-data; boundary=xxxx ä¿®æ”¹ä¸ºå…¶å®ƒæ ¼å¼ï¼Œä½¿å…¶ä¸ç»è¿‡PHPçš„ form-data è§£æï¼›æˆ–æ˜¯æŠŠ php.ini é…ç½®å…³äºPOSTæ•°æ®è§£æçš„ enable_post_data_reading = Off é€‰é¡¹å…³é—­ã€‚ç„¶è€Œè¿™ä¸¤ç§æ–¹æ³•å¹¶ä¸éå¸¸å…·æœ‰æ™®éæ€§ï¼Œåœ¨æŸäº›PHPé…ç½®æ–‡ä»¶ä¸å¯æ§çš„å…±äº«ä¸»æœºçš„ç¯å¢ƒä¸‹å¹¶ä¸é€‚ç”¨ã€‚\näºæ˜¯å¼•å‡ºäº†æœ¬æ–‡è®¨è®ºçš„è¯é¢˜ â€” å¦‚ä½•é‡æ–°ç»„è£… multipart/form-data æ ¼å¼çš„åŸå§‹ POST è¯·æ±‚ä½“ã€‚\nmultipart/form-data æ ¼å¼ åœ¨POSTè¯·æ±‚ä¸­ï¼Œä¸€èˆ¬è¡¨å•ä¼šé€šè¿‡ application/x-www-form-urlencoded æ ¼å¼ä¸Šä¼ ï¼Œä½†æ­¤æ ¼å¼çš„æ•°æ®ä»…æ”¯æŒæ–‡æœ¬æ ¼å¼ï¼Œä¸æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸Šä¼ ã€‚ä¸ºäº†æ”¯æŒè¡¨å• POST æ–‡ä»¶ä¸Šä¼ ï¼ŒRFC1867 å®šä¹‰äº† multipart/form-data çš„æ•°æ®æ ¼å¼ï¼Œå®ç°äº†é€šè¿‡POSTè¯·æ±‚ä¸Šä¼ è¡¨å•çš„å†…å®¹ä»¥åŠäºŒè¿›åˆ¶æ–‡ä»¶æ•°æ®ï¼Œå…³äºæ•°æ®çš„å½¢æ€ï¼Œå‚è€ƒ å››ç§å¸¸è§çš„ POST æäº¤æ•°æ®æ–¹å¼ | JerryQu çš„å°ç«™ ã€‚\nRFC1867 å¯¹äº multipart/form-data çš„æ•°æ®æ ¼å¼ä¸»è¦åœ¨MIME RFC1521 7.2.1 å°èŠ‚å®šä¹‰çš„ã€‚å¦å¤–ï¼Œåœ¨MIME æ ‡å‡† Media Types éƒ¨åˆ† RFC2046 çš„ 5.1.1 èŠ‚ä¸­ï¼Œå¯¹äº multipart-body çš„æ ¼å¼æœ‰ä¸€ä¸ªè¾ƒä¸ºæ¸…æ™°çš„ BNF èŒƒå¼çš„è¯­æ³•å®šä¹‰ï¼Œç®€çŸ­æ€»ç»“å¦‚ä¸‹ï¼ˆæ¥è‡ª Stack Overflowï¼‰ ï¼š\nmultipart-body := [preamble CRLF] dash-boundary CRLF body-part *encapsulation close-delimiter [CRLF epilogue] dash-boundary := \"--\" boundary body-part := MIME-part-headers [CRLF *OCTET] encapsulation := delimiter CRLF body-part delimiter := CRLF dash-boundary close-delimiter := delimiter \"--\" è¿˜åŸ multipart/form-data çš„ä»£ç  å†™ä»£ç å‰æœç´¢å‰äººçš„ç»éªŒï¼Œåœ¨ SegmentFault çœ‹åˆ°äº†ä¸€ä½å‰è¾ˆçš„å®ç°ï¼Œå‚è€ƒå‰è¾ˆçš„ä»£ç ï¼Œä»¥åŠ RFC2046 çš„ BNF è¯­æ³•å®šä¹‰ï¼Œå†™äº†ä»¥ä¸‹ä»£ç ï¼š\n// è¿˜åŸ rfc1867, rfc2046 æ ¼å¼çš„FormData function getFormData() { // body-part array $body = array(); // æ™®é€šå‚æ•° foreach ($_POST as $key =\u003e $value) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"\\r\\n\"; $body_part .= \"\\r\\n$value\"; $body[] = $body_part; } // ä¸Šä¼ æ–‡ä»¶å¤„ç† foreach ($_FILES as $key =\u003e $value) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"; filename=\\\"{$value['name']}\\\"\\r\\n\"; $body_part .= \"Content-type: {$value['type']}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($value['tmp_name']); $body[] = $body_part; } // æå–boundary $boundary = substr($_SERVER['CONTENT_TYPE'], strpos($_SERVER['CONTENT_TYPE'], \"=\") + 1); // multipart-body $multipart_body = \"--$boundary\\r\\n\"; // æ‹¼æ¥å„ä¸ªåŸŸ $multipart_body .= implode(\"\\r\\n--$boundary\\r\\n\", $body); // æœ€åä¸€ä¸ªä¸åŒçš„ boundary $multipart_body .= \"\\r\\n--$boundary--\"; return $multipart_body; } æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ ä»¥ä¸Šä»£ç åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å·¥ä½œæ­£å¸¸ï¼Œä½†æœªè€ƒè™‘åˆ°è¯·æ±‚å‚æ•°çš„ç±»å‹ä¸ºæ•°ç»„çš„æƒ…å†µã€‚\nåœ¨PHPè§£é‡Šå™¨æºç çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è®¸å¤šæ•°ç»„ç±»å‹å‚æ•°çš„æµ‹è¯•ï¼Œéƒ¨åˆ†æ‘˜å½•å¦‚ä¸‹ï¼š\na[]=1 a[]=1\u0026a[]=1 a[]=1\u0026a[0]=5 a[a]=1\u0026a[b]=3 a[]=1\u0026a[a]=1\u0026a[b]=3 a[][]=1\u0026a[][]=3\u0026b[a][b][c]=1\u0026b[a][b][d]=1 a=1\u0026b=ZYX\u0026c[][][][][][][][][][][][][][][][][][][][][][]=123\u0026d=123\u0026e[][]][]=3 Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[]\"; filename=\"file1.txt\" Content-Type: text/plain-file1 1 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[2]\"; filename=\"file2.txt\" Content-Type: text/plain-file2 2 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[]\"; filename=\"file3.txt\" Content-Type: text/plain-file3 3 -----------------------------20896060251896012921717172737-- åœ¨PHPæºç çš„ main/php_variables.c ä¸­çš„ php_register_variable_ex å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸å…³çš„å¤„ç†ï¼š\n/* 99-110è¡Œ */ /* ensure that we don't have spaces or dots in the variable name (not binary safe) */ for (p = var; *p; p++) { if (*p == ' ' || *p == '.') { *p='_'; } else if (*p == '[') { is_array = 1; ip = p; *p = 0; break; } } var_len = p - var; /* 229-235è¡Œ */ ip++; if (*ip == '[') { is_array = 1; *ip = 0; } else { goto plain_var; } å¯è§ï¼Œåœ¨è¿˜åŸPOSTæ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘åˆ°å‚æ•°ä¸ºæ•°ç»„çš„æƒ…å†µã€‚\nè¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ DFS ç®—æ³•æ·±åº¦ä¼˜å…ˆéå†æ•°ç»„ï¼Œç”Ÿæˆç±»ä¼¼ a[0], a[1][1] çš„å­—ç¬¦ä¸²æ¥å®ç°ï¼š\n\u003c?php $arr = [ 'key1' =\u003e [ '_key1' =\u003e 23333, '_key2' =\u003e 66666, ], 'key2' =\u003e \"hahah\", \"test\", ]; var_dump($arr); function dfs(\u0026$node, $prefix, \u0026$result) { if (!is_array($node)) { $result[$prefix] = $node; } else { foreach ($node as $key =\u003e $value) { dfs($value, \"{$prefix}[{$key}]\", $result); } } } dfs($arr, \"arr\", $result); foreach ($result as $key =\u003e $value) { echo \"$key = $value\\n\"; } è¿è¡Œç»“æœï¼š\narray(3) { [\"key1\"]=\u003e array(2) { [\"_key1\"]=\u003e int(23333) [\"_key2\"]=\u003e int(66666) } [\"key2\"]=\u003e string(5) \"hahah\" [0]=\u003e string(4) \"test\" } arr[key1][_key1] = 23333 arr[key1][_key2] = 66666 arr[key2] = hahah arr[0] = test è‡³äº $_FILES æ•°ç»„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåç›´è§‰çš„æƒ…å†µï¼Œå…·ä½“åœ¨æ–‡æ¡£ä¸­ä¹Ÿæœ‰äººæå‡ºï¼š PHP: POST method uploads - Manual\nç®€å•åœ°è¯´ï¼Œå½“è¡¨å•ä¸­æ–‡ä»¶åŸŸçš„keyä¸ºæ•°ç»„å½¢å¼æ—¶ï¼Œæ‹¿åˆ°çš„ $_FILES æ•°ç»„ç±»ä¼¼å¦‚ä¸‹çš„æ ¼å¼ï¼š\narray(1) { [\"key\"]=\u003e array(5) { [\"name\"]=\u003e array(2) { [0]=\u003e string(8) \"test.txt\" [1]=\u003e array(1) { [0]=\u003e string(8) \"test.txt\" } } [\"type\"]=\u003e array(2) { [0]=\u003e string(10) \"text/plain\" [1]=\u003e array(1) { [0]=\u003e string(10) \"text/plain\" } } [\"tmp_name\"]=\u003e array(2) { [0]=\u003e string(14) \"/tmp/phpKHCoSt\" [1]=\u003e array(1) { [0]=\u003e string(14) \"/tmp/phpSgtRHe\" } } [\"error\"]=\u003e array(2) { [0]=\u003e int(0) [1]=\u003e array(1) { [0]=\u003e int(0) } } [\"size\"]=\u003e array(2) { [0]=\u003e int(8) [1]=\u003e array(1) { [0]=\u003e int(8) } } } } å‡è®¾æˆ‘çš„ç›®æ ‡æ˜¯ key[1][0] çš„ name å±æ€§ï¼Œåœ¨PHPä¸­æˆ‘ä»¬éœ€è¦é€šè¿‡ $_FILES[â€œkeyâ€][â€œnameâ€][1][0] æ¥è®¿é—®ï¼Œè€Œåœ¨ $_FILES[â€œkeyâ€][â€œnameâ€] ä¸­ï¼Œåé¢çš„ç´¢å¼•çš„å±‚çº§å¹¶ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½ç®€å•åœ°æŒ‡å®š [1][0] æ¥è®¿é—® $_FILES[â€œkeyâ€][â€œnameâ€][1][0]ã€‚æ‰€ä»¥è¿™é‡Œå¾—æœ‰ä¸€äº› hack æ¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘å®ç°äº†ä¸€ä¸ª query_multidimensional_array å‡½æ•°ï¼Œå…·ä½“çœ‹æœ€ç»ˆçš„ä»£ç ã€‚\ngetFormData() ä»£ç å®ç° ä»¥ä¸‹æ˜¯æ•´ä¸ªå‡½æ•°çš„å®Œæ•´å®ç°ï¼š\n// è¿˜åŸ rfc1867, rfc2046 æ ¼å¼çš„FormData function getFormData() { // body-part array $body = array(); // æ™®é€šå‚æ•° foreach ($_POST as $key =\u003e $value) { if (!is_array($value)) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"\\r\\n\"; $body_part .= \"\\r\\n$value\"; $body[] = $body_part; } else { // æ•°ç»„çš„æƒ…å†µå¤„ç† å¦‚ param1[]=xxxx $result = array(); convert_array_key($value, $key, $result); foreach ($result as $k =\u003e $v) { $body_part = \"Content-Disposition: form-data; name=\\\"$k\\\"\\r\\n\"; $body_part .= \"\\r\\n$v\"; $body[] = $body_part; } } } // ä¸Šä¼ æ–‡ä»¶å¤„ç† foreach ($_FILES as $key =\u003e $value) { if (!is_array($value['type'])) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"; filename=\\\"{$value['name']}\\\"\\r\\n\"; $body_part .= \"Content-type: {$value['type']}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($value['tmp_name']); $body[] = $body_part; } else { // æ–‡ä»¶keyæ˜¯æ•°ç»„çš„æƒ…å†µ å¦‚ file1[]=xxxx $result = array(); convert_array_key($value['type'], \"\", $result); foreach ($result as $k =\u003e $v) { $filename = query_multidimensional_array($value['name'], $k); $type = query_multidimensional_array($value['type'], $k); $tmp_name = query_multidimensional_array($value['tmp_name'], $k); $body_part = \"Content-Disposition: form-data; name=\\\"{$key}{$k}\\\"; filename=\\\"{$filename}\\\"\\r\\n\"; $body_part .= \"Content-type: {$type}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($tmp_name); $body[] = $body_part; } } } // æå–boundary $boundary = substr($_SERVER['CONTENT_TYPE'], strpos($_SERVER['CONTENT_TYPE'], \"=\") + 1); // multipart-body $multipart_body = \"--$boundary\\r\\n\"; // æ‹¼æ¥å„ä¸ªåŸŸ $multipart_body .= implode(\"\\r\\n--$boundary\\r\\n\", $body); // æœ€åä¸€ä¸ªä¸åŒçš„ boundary $multipart_body .= \"\\r\\n--$boundary--\"; return $multipart_body; } // ç›´æ¥è®¿é—®å¤šç»´æ•°ç»„å…ƒç´  // query: [0][0] -\u003e $array[0][0] function query_multidimensional_array(\u0026$array, $query) { $query = explode('][', substr($query, 1, -1)); $temp = $array; foreach ($query as $key) { $temp = $temp[$key]; } return $temp; } // DFSå°†æ•°ç»„å˜ä¸ºä¸€ç»´å½¢å¼ function convert_array_key(\u0026$node, $prefix, \u0026$result) { if (!is_array($node)) { $result[$prefix] = $node; } else { foreach ($node as $key =\u003e $value) { convert_array_key($value, \"{$prefix}[{$key}]\", $result); } } } è‡³æ­¤ï¼Œåœ¨PHPè„šæœ¬ä¸­ï¼Œåªéœ€è°ƒç”¨ getFormData() ï¼Œå³å¯è·å¾— multipart/form-data è¯·æ±‚çš„åŸå§‹æ•°æ®ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç å¯ä»¥å®ç°ä¸€é”®è·å–è¯·æ±‚åŸå§‹POST Bodyã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥æ•°ç»„ç±»å‹å‚æ•°æ˜¯ a[] è¿™ç§å½¢å¼ï¼Œç»è¿‡æœ¬å‡½æ•°è¿˜åŸåä¼šè¡¥å……å…·ä½“çš„ä¸‹æ ‡ï¼Œæ¯”å¦‚è¯´è¿™é‡Œçš„ a[] ä¼šè¢«å¤„ç†æˆ a[0] ï¼Œa[][] åˆ™ä¸º a[0][0]ã€‚ä»è€Œå¯¼è‡´äº† POST Body é•¿åº¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥ç»“æœéœ€è¦ç”¨äºå‘åŒ…ç­‰æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¡ç®— Content-Length ï¼Œé¿å…è¯·æ±‚å‡ºç°é—®é¢˜ã€‚\nif (@$_SERVER['CONTENT_TYPE'] \u0026\u0026 strpos($_SERVER['CONTENT_TYPE'], \"multipart/form-data\") !== false) { $body = getFormData(); $content_length = strlen($body); } else { $body = file_get_contents('php://input'); } PHPä¸­ä»¥multipart/form-dataä¸Šä¼ æ–‡ä»¶æµ ä¸Šä¼ ç±»:\nclass UploadPart { protected static $url; protected static $delimiter; protected static $instance; public function __construct() { static::$url = 'ä¸Šä¼ åœ°å€'; static::$delimiter = uniqid(); // ç”Ÿæˆ } public function putPart($param) { $post_data = static::buildData($param); $curl = curl_init(static::$url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data); curl_setopt($curl, CURLOPT_HTTPHEADER, [ \"Content-Type: multipart/form-data; boundary=\" . static::$delimiter, \"Content-Length: \" . strlen($post_data) ]); $response = curl_exec($curl); curl_close($curl); $info = json_decode($response, true); if (!is_array($info['Msg']) \u0026\u0026 $info['Msg'] == $param['filesize']) { $param['offset'] = $param['filesize']; $param['upload'] = ''; return $this-\u003eputPart($param); } return $response; } private static function buildData($param){ $data = ''; $eol = \"\\r\\n\"; $upload = $param['upload']; unset($param['upload']); foreach ($param as $name =\u003e $content) { $data .= \"--\" . static::$delimiter . \"\\r\\n\" . 'Content-Disposition: form-data; name=\"' . $name . \"\\\"\\r\\n\\r\\n\" . $content . \"\\r\\n\"; } // æ‹¼æ¥æ–‡ä»¶æµ $data .= \"--\" . static::$delimiter . $eol . 'Content-Disposition: form-data; name=\"upload\"; filename=\"' . $param['filename'] . '\"' . \"\\r\\n\" . 'Content-Type:application/octet-stream'.\"\\r\\n\\r\\n\"; $data .= $upload . \"\\r\\n\"; $data .= \"--\" . static::$delimiter . \"--\\r\\n\"; return $data; } public static function getInstance() { if(!static::$instance){ static::$instance = new static(); } return static::$instance; } } ä½¿ç”¨æ–¹æ³•\n$fields = array( 'type' =\u003e 'video', 'filename' =\u003e '1407.png', 'filesize' =\u003e 58701, 'offset' =\u003e 0, 'filetype' =\u003e '.acc', 'originName' =\u003e '1407.png', 'upload'=\u003efile_get_contents('0407.png') ); $part = UploadPart::getInstance()-\u003eputPart($fields); å‚è€ƒ RFC1521 RFC1867 RFC2046 PHP: POST æ–¹æ³•ä¸Šä¼  - Manual PHP: ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ - Manual PHPæ–‡ä»¶ä¸Šä¼ æºç åˆ†æ(RFC1867) | é£é›ªä¹‹éš… æ·±å…¥ç†è§£PHPåŸç†ä¹‹æ–‡ä»¶ä¸Šä¼  | é£é›ªä¹‹éš… å››ç§å¸¸è§çš„ POST æäº¤æ•°æ®æ–¹å¼ | JerryQu çš„å°ç«™ php - Get raw post data - Stack Overflow http - Is this a well formed multipart/form-data request? - Stack Overflow http - è¯·é—®å“ªä»½ RFC æ–‡æ¡£å®šä¹‰äº† multipart/form-data çš„æ ¼å¼ï¼Ÿ - SegmentFault æ€å¦ ","wordCount":"2403","inLanguage":"zh","datePublished":"2024-09-25T14:47:27+08:00","dateModified":"2024-09-25T14:47:27+08:00","author":[{"@type":"Person","name":"Lorenwe"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"},"publisher":{"@type":"Organization","name":"Lorenwe Blog","logo":{"@type":"ImageObject","url":"https://lorenwe.eu.org/img/favicon.ico"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lorenwe.eu.org/ accesskey=h title="Lorenwe Blog (Alt + H)"><img src=https://lorenwe.eu.org/img/kaola.png alt=logo aria-label=logo height=35>Lorenwe Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://lorenwe.eu.org/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://lorenwe.eu.org/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://lorenwe.eu.org/posts title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li><a href=https://lorenwe.eu.org/tags title="ğŸ§© æ ‡ç­¾"><span>ğŸ§© æ ‡ç­¾</span></a></li><li><a href=https://lorenwe.eu.org/archives/ title="â±ï¸ æ—¶é—´è½´"><span>â±ï¸ æ—¶é—´è½´</span></a></li><li><a href=https://lorenwe.eu.org/about title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"><span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span></a></li><li><a href=https://lorenwe.eu.org/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://lorenwe.eu.org/>ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://lorenwe.eu.org/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://lorenwe.eu.org/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>PHPæ„é€ multipart/form-dataæ ¼å¼POSTè¯·æ±‚ä½“çš„æ–¹æ³•</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2024-09-25
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>2403å­—
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>5åˆ†é’Ÿ
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>Lorenwe
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://lorenwe.eu.org/tags/php/ style=color:var(--secondary)!important>PHP</a>
&nbsp;<a href=https://lorenwe.eu.org/tags/post/ style=color:var(--secondary)!important>POST</a>
&nbsp;<a href=https://lorenwe.eu.org/tags/http/ style=color:var(--secondary)!important>HTTP</a></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=å¼•è¨€>å¼•è¨€</a></li><li><a href=#multipartform-data-%e6%a0%bc%e5%bc%8f aria-label="multipart/form-data æ ¼å¼">multipart/form-data æ ¼å¼</a></li><li><a href=#%e8%bf%98%e5%8e%9f-multipartform-data-%e7%9a%84%e4%bb%a3%e7%a0%81 aria-label="è¿˜åŸ multipart/form-data çš„ä»£ç ">è¿˜åŸ multipart/form-data çš„ä»£ç </a></li><li><a href=#%e6%95%b0%e7%bb%84%e7%b1%bb%e5%9e%8b%e5%8f%82%e6%95%b0%e7%9a%84%e6%94%af%e6%8c%81 aria-label=æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ>æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ</a></li><li><a href=#getformdata-%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0 aria-label="getFormData() ä»£ç å®ç°">getFormData() ä»£ç å®ç°</a></li><li><a href=#php%e4%b8%ad%e4%bb%a5multipartform-data%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e6%b5%81 aria-label=PHPä¸­ä»¥multipart/form-dataä¸Šä¼ æ–‡ä»¶æµ>PHPä¸­ä»¥multipart/form-dataä¸Šä¼ æ–‡ä»¶æµ</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=å‚è€ƒ>å‚è€ƒ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h3 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h3><p>æœ€è¿‘åœ¨å°è¯•åŸºäº PHP åšä¸€ä¸ªåå‘ä»£ç† HTTP çš„ç¨‹åºï¼Œå…¶ä¸­ä¸€ä¸ªéœ€æ±‚æ˜¯å°†ç¨‹åºæ”¶åˆ°çš„HTTPè¯·æ±‚è¿˜åŸå› <a href=https://www.ietf.org/rfc/rfc2616.txt>RFC2616</a> çš„åŸå§‹æ ¼å¼ã€‚</p><p>åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸»è¦åœ¨è¯·æ±‚ä½“çš„å¤„ç†ä¸Šã€‚åˆ©ç”¨PHPçš„å°è£…åè®®æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– <a href=https://www.php.net/manual/zh/wrappers.php.php>php://input</a> è®¿é—®åŸå§‹çš„POSTä¿¡æ¯ã€‚ä½†è¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªå±€é™ï¼Œå¯¹äº multipart/form-data çš„è¯·æ±‚æ¥è¯´ï¼Œä¸ºäº†æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„æ“ä½œï¼ŒPHPä¼šé¢„å…ˆæŠŠè¯·æ±‚ä½“ä¸­çš„æ–‡ä»¶æš‚å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå¹¶æŠŠå‚æ•°è§£æåˆ°å˜é‡ $_POST å’Œ $_FILES ä¸­ï¼Œ php://input è·å–åŸå§‹è¯·æ±‚çš„åŠŸèƒ½ä¹Ÿéšä¹‹å¤±æ•ˆã€‚</p><p>Stack Overflow ä¸Šçš„ç›¸å…³é—®é¢˜ç»™å‡ºçš„ è§£å†³åŠæ³• æ˜¯ä¿®æ”¹æœåŠ¡å™¨é…ç½®ï¼ŒæŠŠå‘åˆ° PHP è„šæœ¬çš„ Content-Type: multipart/form-data; boundary=xxxx ä¿®æ”¹ä¸ºå…¶å®ƒæ ¼å¼ï¼Œä½¿å…¶ä¸ç»è¿‡PHPçš„ form-data è§£æï¼›æˆ–æ˜¯æŠŠ php.ini é…ç½®å…³äºPOSTæ•°æ®è§£æçš„ <a href=https://www.php.net/manual/en/ini.core.php#ini.enable-post-data-reading>enable_post_data_reading = Off</a> é€‰é¡¹å…³é—­ã€‚ç„¶è€Œè¿™ä¸¤ç§æ–¹æ³•å¹¶ä¸éå¸¸å…·æœ‰æ™®éæ€§ï¼Œåœ¨æŸäº›PHPé…ç½®æ–‡ä»¶ä¸å¯æ§çš„å…±äº«ä¸»æœºçš„ç¯å¢ƒä¸‹å¹¶ä¸é€‚ç”¨ã€‚</p><p>äºæ˜¯å¼•å‡ºäº†æœ¬æ–‡è®¨è®ºçš„è¯é¢˜ â€” å¦‚ä½•é‡æ–°ç»„è£… multipart/form-data æ ¼å¼çš„åŸå§‹ POST è¯·æ±‚ä½“ã€‚</p><h3 id=multipartform-data-æ ¼å¼>multipart/form-data æ ¼å¼<a hidden class=anchor aria-hidden=true href=#multipartform-data-æ ¼å¼>#</a></h3><p>åœ¨POSTè¯·æ±‚ä¸­ï¼Œä¸€èˆ¬è¡¨å•ä¼šé€šè¿‡ application/x-www-form-urlencoded æ ¼å¼ä¸Šä¼ ï¼Œä½†æ­¤æ ¼å¼çš„æ•°æ®ä»…æ”¯æŒæ–‡æœ¬æ ¼å¼ï¼Œä¸æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸Šä¼ ã€‚ä¸ºäº†æ”¯æŒè¡¨å• POST æ–‡ä»¶ä¸Šä¼ ï¼Œ<a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a> å®šä¹‰äº† multipart/form-data çš„æ•°æ®æ ¼å¼ï¼Œå®ç°äº†é€šè¿‡POSTè¯·æ±‚ä¸Šä¼ è¡¨å•çš„å†…å®¹ä»¥åŠäºŒè¿›åˆ¶æ–‡ä»¶æ•°æ®ï¼Œå…³äºæ•°æ®çš„å½¢æ€ï¼Œå‚è€ƒ å››ç§å¸¸è§çš„ POST æäº¤æ•°æ®æ–¹å¼ | JerryQu çš„å°ç«™ ã€‚</p><p><a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a> å¯¹äº multipart/form-data çš„æ•°æ®æ ¼å¼ä¸»è¦åœ¨MIME <a href=https://www.ietf.org/rfc/rfc1521.txt>RFC1521</a> 7.2.1 å°èŠ‚å®šä¹‰çš„ã€‚å¦å¤–ï¼Œåœ¨MIME æ ‡å‡† Media Types éƒ¨åˆ† <a href=https://www.ietf.org/rfc/rfc2046.txt>RFC2046</a> çš„ 5.1.1 èŠ‚ä¸­ï¼Œå¯¹äº multipart-body çš„æ ¼å¼æœ‰ä¸€ä¸ªè¾ƒä¸ºæ¸…æ™°çš„ BNF èŒƒå¼çš„è¯­æ³•å®šä¹‰ï¼Œç®€çŸ­æ€»ç»“å¦‚ä¸‹ï¼ˆæ¥è‡ª <a href=https://stackoverflow.com/questions/27993445/is-this-a-well-formed-multipart-form-data-request>Stack Overflow</a>ï¼‰ ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>multipart-body := [preamble CRLF]
</span></span><span style=display:flex><span>                  dash-boundary CRLF
</span></span><span style=display:flex><span>                  body-part *encapsulation
</span></span><span style=display:flex><span>                  close-delimiter
</span></span><span style=display:flex><span>                  [CRLF epilogue]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dash-boundary := &#34;--&#34; boundary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>body-part := MIME-part-headers [CRLF *OCTET]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>encapsulation := delimiter
</span></span><span style=display:flex><span>                 CRLF body-part
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delimiter := CRLF dash-boundary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>close-delimiter := delimiter &#34;--&#34;
</span></span></code></pre></div><h3 id=è¿˜åŸ-multipartform-data-çš„ä»£ç >è¿˜åŸ multipart/form-data çš„ä»£ç <a hidden class=anchor aria-hidden=true href=#è¿˜åŸ-multipartform-data-çš„ä»£ç >#</a></h3><p>å†™ä»£ç å‰æœç´¢å‰äººçš„ç»éªŒï¼Œåœ¨ SegmentFault çœ‹åˆ°äº†ä¸€ä½<a href=https://segmentfault.com/q/1010000002604013>å‰è¾ˆçš„å®ç°</a>ï¼Œå‚è€ƒå‰è¾ˆçš„ä»£ç ï¼Œä»¥åŠ RFC2046 çš„ BNF è¯­æ³•å®šä¹‰ï¼Œå†™äº†ä»¥ä¸‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// è¿˜åŸ rfc1867, rfc2046 æ ¼å¼çš„FormData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getFormData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// body-part array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $body <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ™®é€šå‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>foreach</span> ($_POST <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$value<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // ä¸Šä¼ æ–‡ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  foreach (</span><span style=color:#e6db74>$_FILES</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$key</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span>; <span style=color:#a6e22e>filename</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;type&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>]);
</span></span><span style=display:flex><span>    $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æå–boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $boundary <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;=&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// multipart-body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‹¼æ¥å„ä¸ªåŸŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>, $body);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æœ€åä¸€ä¸ªä¸åŒçš„ boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary</span><span style=color:#e6db74>--&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $multipart_body;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ>æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ<a hidden class=anchor aria-hidden=true href=#æ•°ç»„ç±»å‹å‚æ•°çš„æ”¯æŒ>#</a></h3><p>ä»¥ä¸Šä»£ç åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å·¥ä½œæ­£å¸¸ï¼Œä½†æœªè€ƒè™‘åˆ°è¯·æ±‚å‚æ•°çš„ç±»å‹ä¸ºæ•°ç»„çš„æƒ…å†µã€‚</p><p>åœ¨PHPè§£é‡Šå™¨æºç çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è®¸å¤šæ•°ç»„ç±»å‹å‚æ•°çš„æµ‹è¯•ï¼Œéƒ¨åˆ†æ‘˜å½•å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>a[]=1
</span></span><span style=display:flex><span>a[]=1&amp;a[]=1
</span></span><span style=display:flex><span>a[]=1&amp;a[0]=5
</span></span><span style=display:flex><span>a[a]=1&amp;a[b]=3
</span></span><span style=display:flex><span>a[]=1&amp;a[a]=1&amp;a[b]=3
</span></span><span style=display:flex><span>a[][]=1&amp;a[][]=3&amp;b[a][b][c]=1&amp;b[a][b][d]=1
</span></span><span style=display:flex><span>a=1&amp;b=ZYX&amp;c[][][][][][][][][][][][][][][][][][][][][][]=123&amp;d=123&amp;e[][]][]=3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[]&#34;; filename=&#34;file1.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[2]&#34;; filename=&#34;file2.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[]&#34;; filename=&#34;file3.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737--
</span></span></code></pre></div><p>åœ¨PHPæºç çš„ main/php_variables.c ä¸­çš„ php_register_variable_ex å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸å…³çš„å¤„ç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* 99-110è¡Œ */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ensure that we don&#39;t have spaces or dots in the variable name (not binary safe) */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (p <span style=color:#f92672>=</span> var; <span style=color:#f92672>*</span>p; p<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> <span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;_&#39;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;[&#39;</span>) {
</span></span><span style=display:flex><span>        is_array <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        ip <span style=color:#f92672>=</span> p;
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>var_len <span style=color:#f92672>=</span> p <span style=color:#f92672>-</span> var;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 229-235è¡Œ */</span>
</span></span><span style=display:flex><span>ip<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>ip <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;[&#39;</span>) {
</span></span><span style=display:flex><span>    is_array <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>ip <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> plain_var;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯è§ï¼Œåœ¨è¿˜åŸPOSTæ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘åˆ°å‚æ•°ä¸ºæ•°ç»„çš„æƒ…å†µã€‚</p><p>è¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ DFS ç®—æ³•æ·±åº¦ä¼˜å…ˆéå†æ•°ç»„ï¼Œç”Ÿæˆç±»ä¼¼ a[0], a[1][1] çš„å­—ç¬¦ä¸²æ¥å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$arr <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;key1&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;_key1&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>23333</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;_key2&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>66666</span>,
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;key2&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;hahah&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var_dump</span>($arr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dfs</span>(<span style=color:#f92672>&amp;</span>$node, $prefix, <span style=color:#f92672>&amp;</span>$result) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($node)) {
</span></span><span style=display:flex><span>    $result[$prefix] <span style=color:#f92672>=</span> $node;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($node <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dfs</span>($value, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>[</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>, $result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dfs</span>($arr, <span style=color:#e6db74>&#34;arr&#34;</span>, $result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($result <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key</span><span style=color:#e6db74> = </span><span style=color:#e6db74>$value\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿è¡Œç»“æœï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>array(3) {
</span></span><span style=display:flex><span>  [&#34;key1&#34;]=&gt;
</span></span><span style=display:flex><span>  array(2) {
</span></span><span style=display:flex><span>    [&#34;_key1&#34;]=&gt;
</span></span><span style=display:flex><span>    int(23333)
</span></span><span style=display:flex><span>    [&#34;_key2&#34;]=&gt;
</span></span><span style=display:flex><span>    int(66666)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  [&#34;key2&#34;]=&gt;
</span></span><span style=display:flex><span>  string(5) &#34;hahah&#34;
</span></span><span style=display:flex><span>  [0]=&gt;
</span></span><span style=display:flex><span>  string(4) &#34;test&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>arr[key1][_key1] = 23333
</span></span><span style=display:flex><span>arr[key1][_key2] = 66666
</span></span><span style=display:flex><span>arr[key2] = hahah
</span></span><span style=display:flex><span>arr[0] = test
</span></span></code></pre></div><p>è‡³äº $_FILES æ•°ç»„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåç›´è§‰çš„æƒ…å†µï¼Œå…·ä½“åœ¨æ–‡æ¡£ä¸­ä¹Ÿæœ‰äººæå‡ºï¼š <a href=http://php.net/manual/en/features.file-upload.post-method.php#91479>PHP: POST method uploads - Manual</a></p><p>ç®€å•åœ°è¯´ï¼Œå½“è¡¨å•ä¸­æ–‡ä»¶åŸŸçš„keyä¸ºæ•°ç»„å½¢å¼æ—¶ï¼Œæ‹¿åˆ°çš„ $_FILES æ•°ç»„ç±»ä¼¼å¦‚ä¸‹çš„æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>array(1) {
</span></span><span style=display:flex><span>  [&#34;key&#34;]=&gt;
</span></span><span style=display:flex><span>  array(5) {
</span></span><span style=display:flex><span>    [&#34;name&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(8) &#34;test.txt&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(8) &#34;test.txt&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;type&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(10) &#34;text/plain&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(10) &#34;text/plain&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;tmp_name&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(14) &#34;/tmp/phpKHCoSt&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(14) &#34;/tmp/phpSgtRHe&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;error&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      int(0)
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        int(0)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;size&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      int(8)
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        int(8)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å‡è®¾æˆ‘çš„ç›®æ ‡æ˜¯ key[1][0] çš„ name å±æ€§ï¼Œåœ¨PHPä¸­æˆ‘ä»¬éœ€è¦é€šè¿‡ $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;][1][0] æ¥è®¿é—®ï¼Œè€Œåœ¨ $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;] ä¸­ï¼Œåé¢çš„ç´¢å¼•çš„å±‚çº§å¹¶ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½ç®€å•åœ°æŒ‡å®š [1][0] æ¥è®¿é—® $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;][1][0]ã€‚æ‰€ä»¥è¿™é‡Œå¾—æœ‰ä¸€äº› hack æ¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘å®ç°äº†ä¸€ä¸ª query_multidimensional_array å‡½æ•°ï¼Œå…·ä½“çœ‹æœ€ç»ˆçš„ä»£ç ã€‚</p><h3 id=getformdata-ä»£ç å®ç°>getFormData() ä»£ç å®ç°<a hidden class=anchor aria-hidden=true href=#getformdata-ä»£ç å®ç°>#</a></h3><p>ä»¥ä¸‹æ˜¯æ•´ä¸ªå‡½æ•°çš„å®Œæ•´å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// è¿˜åŸ rfc1867, rfc2046 æ ¼å¼çš„FormData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getFormData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// body-part array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $body <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ™®é€šå‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>foreach</span> ($_POST <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($value)) {
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$value<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    } else {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      // æ•°ç»„çš„æƒ…å†µå¤„ç† å¦‚ param1[]=xxxx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$result</span><span style=color:#e6db74> = array();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      convert_array_key(</span><span style=color:#e6db74>$value</span><span style=color:#e6db74>, </span><span style=color:#e6db74>$key</span><span style=color:#e6db74>, </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      foreach (</span><span style=color:#e6db74>$result</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$k</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$v</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$k\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$v<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // ä¸Šä¼ æ–‡ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  foreach (</span><span style=color:#e6db74>$_FILES</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$key</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if (!is_array(</span><span style=color:#e6db74>$value[&#39;type&#39;]</span><span style=color:#e6db74>)) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span>; <span style=color:#a6e22e>filename</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;type&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>]);
</span></span><span style=display:flex><span>      $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ–‡ä»¶keyæ˜¯æ•°ç»„çš„æƒ…å†µ å¦‚ file1[]=xxxx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      $result <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>convert_array_key</span>($value[<span style=color:#e6db74>&#39;type&#39;</span>], <span style=color:#e6db74>&#34;&#34;</span>, $result);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>foreach</span> ($result <span style=color:#66d9ef>as</span> $k <span style=color:#f92672>=&gt;</span> $v) {
</span></span><span style=display:flex><span>        $filename <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;name&#39;</span>], $k);
</span></span><span style=display:flex><span>        $type <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;type&#39;</span>], $k);
</span></span><span style=display:flex><span>        $tmp_name <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>], $k);
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}{</span>$k<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>; filename=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{</span>$filename<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$type<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($tmp_name);
</span></span><span style=display:flex><span>        $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æå–boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $boundary <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;=&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// multipart-body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‹¼æ¥å„ä¸ªåŸŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>, $body);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æœ€åä¸€ä¸ªä¸åŒçš„ boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary</span><span style=color:#e6db74>--&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $multipart_body;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›´æ¥è®¿é—®å¤šç»´æ•°ç»„å…ƒç´ 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// query: [0][0] -&gt; $array[0][0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>query_multidimensional_array</span>(<span style=color:#f92672>&amp;</span>$array, $query) {
</span></span><span style=display:flex><span>  $query <span style=color:#f92672>=</span> <span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#39;][&#39;</span>, <span style=color:#a6e22e>substr</span>($query, <span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>  $temp <span style=color:#f92672>=</span> $array;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>foreach</span> ($query <span style=color:#66d9ef>as</span> $key) {
</span></span><span style=display:flex><span>    $temp <span style=color:#f92672>=</span> $temp[$key];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $temp;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DFSå°†æ•°ç»„å˜ä¸ºä¸€ç»´å½¢å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>convert_array_key</span>(<span style=color:#f92672>&amp;</span>$node, $prefix, <span style=color:#f92672>&amp;</span>$result) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($node)) {
</span></span><span style=display:flex><span>    $result[$prefix] <span style=color:#f92672>=</span> $node;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($node <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>convert_array_key</span>($value, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>[</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>, $result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œåœ¨PHPè„šæœ¬ä¸­ï¼Œåªéœ€è°ƒç”¨ getFormData() ï¼Œå³å¯è·å¾— multipart/form-data è¯·æ±‚çš„åŸå§‹æ•°æ®ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç å¯ä»¥å®ç°ä¸€é”®è·å–è¯·æ±‚åŸå§‹POST Bodyã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥æ•°ç»„ç±»å‹å‚æ•°æ˜¯ a[] è¿™ç§å½¢å¼ï¼Œç»è¿‡æœ¬å‡½æ•°è¿˜åŸåä¼šè¡¥å……å…·ä½“çš„ä¸‹æ ‡ï¼Œæ¯”å¦‚è¯´è¿™é‡Œçš„ a[] ä¼šè¢«å¤„ç†æˆ a[0] ï¼Œa[][] åˆ™ä¸º a[0][0]ã€‚ä»è€Œå¯¼è‡´äº† POST Body é•¿åº¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥ç»“æœéœ€è¦ç”¨äºå‘åŒ…ç­‰æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¡ç®— Content-Length ï¼Œé¿å…è¯·æ±‚å‡ºç°é—®é¢˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>@</span>$_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;multipart/form-data&#34;</span>) <span style=color:#f92672>!==</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>  $body <span style=color:#f92672>=</span> <span style=color:#a6e22e>getFormData</span>();
</span></span><span style=display:flex><span>  $content_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>($body);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  $body <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#39;php://input&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=phpä¸­ä»¥multipartform-dataä¸Šä¼ æ–‡ä»¶æµ>PHPä¸­ä»¥multipart/form-dataä¸Šä¼ æ–‡ä»¶æµ<a hidden class=anchor aria-hidden=true href=#phpä¸­ä»¥multipartform-dataä¸Šä¼ æ–‡ä»¶æµ>#</a></h3><p>ä¸Šä¼ ç±»:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UploadPart</span>
</span></span><span style=display:flex><span>{   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $url;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $delimiter;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $instance;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ä¸Šä¼ åœ°å€&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>=</span> <span style=color:#a6e22e>uniqid</span>(); <span style=color:#75715e>// ç”Ÿæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>putPart</span>($param) {
</span></span><span style=display:flex><span>        $post_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span><span style=color:#a6e22e>buildData</span>($param);
</span></span><span style=display:flex><span>        $curl <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_init</span>(<span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$url);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_RETURNTRANSFER</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_POST</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_POSTFIELDS</span>, $post_data);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_HTTPHEADER</span>, [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Type: multipart/form-data; boundary=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Length: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>strlen</span>($post_data)
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>        $response <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_exec</span>($curl);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_close</span>($curl);
</span></span><span style=display:flex><span>        $info <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_decode</span>($response, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($info[<span style=color:#e6db74>&#39;Msg&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> $info[<span style=color:#e6db74>&#39;Msg&#39;</span>] <span style=color:#f92672>==</span> $param[<span style=color:#e6db74>&#39;filesize&#39;</span>]) {
</span></span><span style=display:flex><span>            $param[<span style=color:#e6db74>&#39;offset&#39;</span>] <span style=color:#f92672>=</span> $param[<span style=color:#e6db74>&#39;filesize&#39;</span>];
</span></span><span style=display:flex><span>            $param[<span style=color:#e6db74>&#39;upload&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>putPart</span>($param);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $response;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>buildData</span>($param){
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>        $eol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $upload <span style=color:#f92672>=</span> $param[<span style=color:#e6db74>&#39;upload&#39;</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unset</span>($param[<span style=color:#e6db74>&#39;upload&#39;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($param <span style=color:#66d9ef>as</span> $name <span style=color:#f92672>=&gt;</span> $content) {
</span></span><span style=display:flex><span>            $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Disposition: form-data; name=&#34;&#39;</span> <span style=color:#f92672>.</span> $name <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;\r\n\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span> $content <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ‹¼æ¥æ–‡ä»¶æµ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> $eol
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Disposition: form-data; name=&#34;upload&#34;; filename=&#34;&#39;</span> <span style=color:#f92672>.</span> $param[<span style=color:#e6db74>&#39;filename&#39;</span>] <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;&#34;&#39;</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Type:application/octet-stream&#39;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>.=</span> $upload <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;--</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $data;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getInstance</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>static</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½¿ç”¨æ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$fields <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;video&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filename&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1407.png&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filesize&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>58701</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;offset&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filetype&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;.acc&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;originName&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1407.png&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;upload&#39;</span><span style=color:#f92672>=&gt;</span><span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#39;0407.png&#39;</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>$part <span style=color:#f92672>=</span> <span style=color:#a6e22e>UploadPart</span><span style=color:#f92672>::</span><span style=color:#a6e22e>getInstance</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>putPart</span>($fields);
</span></span></code></pre></div><h3 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>#</a></h3><ul><li><a href=https://www.ietf.org/rfc/rfc1521.txt>RFC1521</a></li><li><a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a></li><li><a href=https://www.ietf.org/rfc/rfc2046.txt>RFC2046</a></li><li><a href=https://www.php.net/manual/zh/features.file-upload.post-method.php>PHP: POST æ–¹æ³•ä¸Šä¼  - Manual</a></li><li><a href=https://www.php.net/manual/zh/features.file-upload.multiple.php>PHP: ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ - Manual</a></li><li><a href=https://www.laruence.com/2009/09/26/1103.html>PHPæ–‡ä»¶ä¸Šä¼ æºç åˆ†æ(RFC1867) | é£é›ªä¹‹éš…</a></li><li><a href=https://www.laruence.com/2008/11/07/586.html>æ·±å…¥ç†è§£PHPåŸç†ä¹‹æ–‡ä»¶ä¸Šä¼  | é£é›ªä¹‹éš…</a></li><li><a href=https://imququ.com/post/four-ways-to-post-data-in-http.html>å››ç§å¸¸è§çš„ POST æäº¤æ•°æ®æ–¹å¼ | JerryQu çš„å°ç«™</a></li><li><a href=https://stackoverflow.com/questions/1361673/get-raw-post-data>php - Get raw post data - Stack Overflow</a></li><li><a href=https://stackoverflow.com/questions/27993445/is-this-a-well-formed-multipart-form-data-request>http - Is this a well formed multipart/form-data request? - Stack Overflow</a></li><li><a href=https://segmentfault.com/q/1010000002604013>http - è¯·é—®å“ªä»½ RFC æ–‡æ¡£å®šä¹‰äº† multipart/form-data çš„æ ¼å¼ï¼Ÿ - SegmentFault æ€å¦</a></li></ul></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://lorenwe.eu.org/img/wechat_pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://lorenwe.eu.org/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://lorenwe.eu.org/posts/tech/%E5%9B%9B%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84post%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E6%96%B9%E5%BC%8F/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>å››ç§å¸¸è§çš„POSTæäº¤æ•°æ®æ–¹å¼</span>
</a><a class=next href=https://lorenwe.eu.org/posts/tech/win10%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAgithub%E8%B4%A6%E5%8F%B7/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Win10é…ç½®å¤šä¸ªGithubè´¦å·</span></a></nav></footer></div><div id=giscus-comment></div><script>function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");if(!t||!t.contentWindow)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}function createGusicScript(){const t=document.querySelector("#giscus-comment"),n=localStorage.getItem("pref-theme");let e=document.createElement("script");e.src="https://giscus.app/client.js",e.setAttribute("data-repo","lorenwe/lorenwe.github.io"),e.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnk3NDY0NzM4MQ=="),e.setAttribute("data-category","Announcements"),e.setAttribute("data-category-id","DIC_kwDOBHMHVc4CizTN"),e.setAttribute("data-mapping","title"),e.setAttribute("data-strict","0"),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",n),e.setAttribute("data-lang","zh-CN"),e.setAttribute("data-loading","lazy"),e.setAttribute("crossorigin","anonymous"),e.async=!0,t&&t.appendChild(e)}createGusicScript()</script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),sendMessage({setConfig:{theme:"light"}})):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),sendMessage({setConfig:{theme:"dark"}}))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`\r

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒLorenwe Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚\r
åŸæ–‡é“¾æ¥ï¼š`+location.href,s=window.getSelection().toString()+`\r

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒLorenwe Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚\r
åŸæ–‡é“¾æ¥ï¼š`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="å¤åˆ¶";function i(){t.innerText="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerText="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`\r
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒLorenwe Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚\r
åŸæ–‡é“¾æ¥ï¼š`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>