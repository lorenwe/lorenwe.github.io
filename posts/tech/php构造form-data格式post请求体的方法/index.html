<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PHP构造multipart/form-data格式POST请求体的方法 | Lorenwe Blog</title>
<meta name=keywords content="PHP,POST,HTTP"><meta name=description content="引言
最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 RFC2616 的原始格式。
在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 php://input 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。"><meta name=author content="Lorenwe"><link rel=canonical href=https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://lorenwe.eu.org/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lorenwe.eu.org/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lorenwe.eu.org/img/favicon.ico><link rel=apple-touch-icon href=https://lorenwe.eu.org/img/favicon.ico><link rel=mask-icon href=https://lorenwe.eu.org/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js></script><meta property="og:title" content="PHP构造multipart/form-data格式POST请求体的方法"><meta property="og:description" content="引言
最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 RFC2616 的原始格式。
在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 php://input 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。"><meta property="og:type" content="article"><meta property="og:url" content="https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-25T14:47:27+08:00"><meta property="article:modified_time" content="2024-09-25T14:47:27+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP构造multipart/form-data格式POST请求体的方法"><meta name=twitter:description content="引言
最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 RFC2616 的原始格式。
在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 php://input 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://lorenwe.eu.org/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://lorenwe.eu.org/posts/tech/"},{"@type":"ListItem","position":3,"name":"PHP构造multipart/form-data格式POST请求体的方法","item":"https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PHP构造multipart/form-data格式POST请求体的方法","name":"PHP构造multipart\/form-data格式POST请求体的方法","description":"引言 最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 RFC2616 的原始格式。\n在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 php://input 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。\n","keywords":["PHP","POST","HTTP"],"articleBody":"引言 最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 RFC2616 的原始格式。\n在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 php://input 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。\nStack Overflow 上的相关问题给出的 解决办法 是修改服务器配置，把发到 PHP 脚本的 Content-Type: multipart/form-data; boundary=xxxx 修改为其它格式，使其不经过PHP的 form-data 解析；或是把 php.ini 配置关于POST数据解析的 enable_post_data_reading = Off 选项关闭。然而这两种方法并不非常具有普遍性，在某些PHP配置文件不可控的共享主机的环境下并不适用。\n于是引出了本文讨论的话题 — 如何重新组装 multipart/form-data 格式的原始 POST 请求体。\nmultipart/form-data 格式 在POST请求中，一般表单会通过 application/x-www-form-urlencoded 格式上传，但此格式的数据仅支持文本格式，不支持二进制文件的上传。为了支持表单 POST 文件上传，RFC1867 定义了 multipart/form-data 的数据格式，实现了通过POST请求上传表单的内容以及二进制文件数据，关于数据的形态，参考 四种常见的 POST 提交数据方式 | JerryQu 的小站 。\nRFC1867 对于 multipart/form-data 的数据格式主要在MIME RFC1521 7.2.1 小节定义的。另外，在MIME 标准 Media Types 部分 RFC2046 的 5.1.1 节中，对于 multipart-body 的格式有一个较为清晰的 BNF 范式的语法定义，简短总结如下（来自 Stack Overflow） ：\nmultipart-body := [preamble CRLF] dash-boundary CRLF body-part *encapsulation close-delimiter [CRLF epilogue] dash-boundary := \"--\" boundary body-part := MIME-part-headers [CRLF *OCTET] encapsulation := delimiter CRLF body-part delimiter := CRLF dash-boundary close-delimiter := delimiter \"--\" 还原 multipart/form-data 的代码 写代码前搜索前人的经验，在 SegmentFault 看到了一位前辈的实现，参考前辈的代码，以及 RFC2046 的 BNF 语法定义，写了以下代码：\n// 还原 rfc1867, rfc2046 格式的FormData function getFormData() { // body-part array $body = array(); // 普通参数 foreach ($_POST as $key =\u003e $value) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"\\r\\n\"; $body_part .= \"\\r\\n$value\"; $body[] = $body_part; } // 上传文件处理 foreach ($_FILES as $key =\u003e $value) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"; filename=\\\"{$value['name']}\\\"\\r\\n\"; $body_part .= \"Content-type: {$value['type']}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($value['tmp_name']); $body[] = $body_part; } // 提取boundary $boundary = substr($_SERVER['CONTENT_TYPE'], strpos($_SERVER['CONTENT_TYPE'], \"=\") + 1); // multipart-body $multipart_body = \"--$boundary\\r\\n\"; // 拼接各个域 $multipart_body .= implode(\"\\r\\n--$boundary\\r\\n\", $body); // 最后一个不同的 boundary $multipart_body .= \"\\r\\n--$boundary--\"; return $multipart_body; } 数组类型参数的支持 以上代码在大多数情况下工作正常，但未考虑到请求参数的类型为数组的情况。\n在PHP解释器源码的测试用例中，我们可以找到许多数组类型参数的测试，部分摘录如下：\na[]=1 a[]=1\u0026a[]=1 a[]=1\u0026a[0]=5 a[a]=1\u0026a[b]=3 a[]=1\u0026a[a]=1\u0026a[b]=3 a[][]=1\u0026a[][]=3\u0026b[a][b][c]=1\u0026b[a][b][d]=1 a=1\u0026b=ZYX\u0026c[][][][][][][][][][][][][][][][][][][][][][]=123\u0026d=123\u0026e[][]][]=3 Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[]\"; filename=\"file1.txt\" Content-Type: text/plain-file1 1 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[2]\"; filename=\"file2.txt\" Content-Type: text/plain-file2 2 -----------------------------20896060251896012921717172737 Content-Disposition: form-data; name=\"file[]\"; filename=\"file3.txt\" Content-Type: text/plain-file3 3 -----------------------------20896060251896012921717172737-- 在PHP源码的 main/php_variables.c 中的 php_register_variable_ex 函数中，我们可以看到相关的处理：\n/* 99-110行 */ /* ensure that we don't have spaces or dots in the variable name (not binary safe) */ for (p = var; *p; p++) { if (*p == ' ' || *p == '.') { *p='_'; } else if (*p == '[') { is_array = 1; ip = p; *p = 0; break; } } var_len = p - var; /* 229-235行 */ ip++; if (*ip == '[') { is_array = 1; *ip = 0; } else { goto plain_var; } 可见，在还原POST数据的时候，我们还需要考虑到参数为数组的情况。\n这里通过一个简单的 DFS 算法深度优先遍历数组，生成类似 a[0], a[1][1] 的字符串来实现：\n\u003c?php $arr = [ 'key1' =\u003e [ '_key1' =\u003e 23333, '_key2' =\u003e 66666, ], 'key2' =\u003e \"hahah\", \"test\", ]; var_dump($arr); function dfs(\u0026$node, $prefix, \u0026$result) { if (!is_array($node)) { $result[$prefix] = $node; } else { foreach ($node as $key =\u003e $value) { dfs($value, \"{$prefix}[{$key}]\", $result); } } } dfs($arr, \"arr\", $result); foreach ($result as $key =\u003e $value) { echo \"$key = $value\\n\"; } 运行结果：\narray(3) { [\"key1\"]=\u003e array(2) { [\"_key1\"]=\u003e int(23333) [\"_key2\"]=\u003e int(66666) } [\"key2\"]=\u003e string(5) \"hahah\" [0]=\u003e string(4) \"test\" } arr[key1][_key1] = 23333 arr[key1][_key2] = 66666 arr[key2] = hahah arr[0] = test 至于 $_FILES 数组，这里有一个反直觉的情况，具体在文档中也有人提出： PHP: POST method uploads - Manual\n简单地说，当表单中文件域的key为数组形式时，拿到的 $_FILES 数组类似如下的格式：\narray(1) { [\"key\"]=\u003e array(5) { [\"name\"]=\u003e array(2) { [0]=\u003e string(8) \"test.txt\" [1]=\u003e array(1) { [0]=\u003e string(8) \"test.txt\" } } [\"type\"]=\u003e array(2) { [0]=\u003e string(10) \"text/plain\" [1]=\u003e array(1) { [0]=\u003e string(10) \"text/plain\" } } [\"tmp_name\"]=\u003e array(2) { [0]=\u003e string(14) \"/tmp/phpKHCoSt\" [1]=\u003e array(1) { [0]=\u003e string(14) \"/tmp/phpSgtRHe\" } } [\"error\"]=\u003e array(2) { [0]=\u003e int(0) [1]=\u003e array(1) { [0]=\u003e int(0) } } [\"size\"]=\u003e array(2) { [0]=\u003e int(8) [1]=\u003e array(1) { [0]=\u003e int(8) } } } } 假设我的目标是 key[1][0] 的 name 属性，在PHP中我们需要通过 $_FILES[“key”][“name”][1][0] 来访问，而在 $_FILES[“key”][“name”] 中，后面的索引的层级并不确定的，我们也不能简单地指定 [1][0] 来访问 $_FILES[“key”][“name”][1][0]。所以这里得有一些 hack 来优化一下这个过程，这里我实现了一个 query_multidimensional_array 函数，具体看最终的代码。\ngetFormData() 代码实现 以下是整个函数的完整实现：\n// 还原 rfc1867, rfc2046 格式的FormData function getFormData() { // body-part array $body = array(); // 普通参数 foreach ($_POST as $key =\u003e $value) { if (!is_array($value)) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"\\r\\n\"; $body_part .= \"\\r\\n$value\"; $body[] = $body_part; } else { // 数组的情况处理 如 param1[]=xxxx $result = array(); convert_array_key($value, $key, $result); foreach ($result as $k =\u003e $v) { $body_part = \"Content-Disposition: form-data; name=\\\"$k\\\"\\r\\n\"; $body_part .= \"\\r\\n$v\"; $body[] = $body_part; } } } // 上传文件处理 foreach ($_FILES as $key =\u003e $value) { if (!is_array($value['type'])) { $body_part = \"Content-Disposition: form-data; name=\\\"$key\\\"; filename=\\\"{$value['name']}\\\"\\r\\n\"; $body_part .= \"Content-type: {$value['type']}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($value['tmp_name']); $body[] = $body_part; } else { // 文件key是数组的情况 如 file1[]=xxxx $result = array(); convert_array_key($value['type'], \"\", $result); foreach ($result as $k =\u003e $v) { $filename = query_multidimensional_array($value['name'], $k); $type = query_multidimensional_array($value['type'], $k); $tmp_name = query_multidimensional_array($value['tmp_name'], $k); $body_part = \"Content-Disposition: form-data; name=\\\"{$key}{$k}\\\"; filename=\\\"{$filename}\\\"\\r\\n\"; $body_part .= \"Content-type: {$type}\\r\\n\"; $body_part .= \"\\r\\n\".file_get_contents($tmp_name); $body[] = $body_part; } } } // 提取boundary $boundary = substr($_SERVER['CONTENT_TYPE'], strpos($_SERVER['CONTENT_TYPE'], \"=\") + 1); // multipart-body $multipart_body = \"--$boundary\\r\\n\"; // 拼接各个域 $multipart_body .= implode(\"\\r\\n--$boundary\\r\\n\", $body); // 最后一个不同的 boundary $multipart_body .= \"\\r\\n--$boundary--\"; return $multipart_body; } // 直接访问多维数组元素 // query: [0][0] -\u003e $array[0][0] function query_multidimensional_array(\u0026$array, $query) { $query = explode('][', substr($query, 1, -1)); $temp = $array; foreach ($query as $key) { $temp = $temp[$key]; } return $temp; } // DFS将数组变为一维形式 function convert_array_key(\u0026$node, $prefix, \u0026$result) { if (!is_array($node)) { $result[$prefix] = $node; } else { foreach ($node as $key =\u003e $value) { convert_array_key($value, \"{$prefix}[{$key}]\", $result); } } } 至此，在PHP脚本中，只需调用 getFormData() ，即可获得 multipart/form-data 请求的原始数据，通过以下代码可以实现一键获取请求原始POST Body。\n需要注意的是，若数组类型参数是 a[] 这种形式，经过本函数还原后会补充具体的下标，比如说这里的 a[] 会被处理成 a[0] ，a[][] 则为 a[0][0]。从而导致了 POST Body 长度发生变化，若结果需要用于发包等操作，我们需要重新计算 Content-Length ，避免请求出现问题。\nif (@$_SERVER['CONTENT_TYPE'] \u0026\u0026 strpos($_SERVER['CONTENT_TYPE'], \"multipart/form-data\") !== false) { $body = getFormData(); $content_length = strlen($body); } else { $body = file_get_contents('php://input'); } PHP中以multipart/form-data上传文件流 上传类:\nclass UploadPart { protected static $url; protected static $delimiter; protected static $instance; public function __construct() { static::$url = '上传地址'; static::$delimiter = uniqid(); // 生成 } public function putPart($param) { $post_data = static::buildData($param); $curl = curl_init(static::$url); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data); curl_setopt($curl, CURLOPT_HTTPHEADER, [ \"Content-Type: multipart/form-data; boundary=\" . static::$delimiter, \"Content-Length: \" . strlen($post_data) ]); $response = curl_exec($curl); curl_close($curl); $info = json_decode($response, true); if (!is_array($info['Msg']) \u0026\u0026 $info['Msg'] == $param['filesize']) { $param['offset'] = $param['filesize']; $param['upload'] = ''; return $this-\u003eputPart($param); } return $response; } private static function buildData($param){ $data = ''; $eol = \"\\r\\n\"; $upload = $param['upload']; unset($param['upload']); foreach ($param as $name =\u003e $content) { $data .= \"--\" . static::$delimiter . \"\\r\\n\" . 'Content-Disposition: form-data; name=\"' . $name . \"\\\"\\r\\n\\r\\n\" . $content . \"\\r\\n\"; } // 拼接文件流 $data .= \"--\" . static::$delimiter . $eol . 'Content-Disposition: form-data; name=\"upload\"; filename=\"' . $param['filename'] . '\"' . \"\\r\\n\" . 'Content-Type:application/octet-stream'.\"\\r\\n\\r\\n\"; $data .= $upload . \"\\r\\n\"; $data .= \"--\" . static::$delimiter . \"--\\r\\n\"; return $data; } public static function getInstance() { if(!static::$instance){ static::$instance = new static(); } return static::$instance; } } 使用方法\n$fields = array( 'type' =\u003e 'video', 'filename' =\u003e '1407.png', 'filesize' =\u003e 58701, 'offset' =\u003e 0, 'filetype' =\u003e '.acc', 'originName' =\u003e '1407.png', 'upload'=\u003efile_get_contents('0407.png') ); $part = UploadPart::getInstance()-\u003eputPart($fields); 参考 RFC1521 RFC1867 RFC2046 PHP: POST 方法上传 - Manual PHP: 上传多个文件 - Manual PHP文件上传源码分析(RFC1867) | 风雪之隅 深入理解PHP原理之文件上传 | 风雪之隅 四种常见的 POST 提交数据方式 | JerryQu 的小站 php - Get raw post data - Stack Overflow http - Is this a well formed multipart/form-data request? - Stack Overflow http - 请问哪份 RFC 文档定义了 multipart/form-data 的格式？ - SegmentFault 思否 ","wordCount":"2403","inLanguage":"zh","datePublished":"2024-09-25T14:47:27+08:00","dateModified":"2024-09-25T14:47:27+08:00","author":[{"@type":"Person","name":"Lorenwe"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://lorenwe.eu.org/posts/tech/php%E6%9E%84%E9%80%A0form-data%E6%A0%BC%E5%BC%8Fpost%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%96%B9%E6%B3%95/"},"publisher":{"@type":"Organization","name":"Lorenwe Blog","logo":{"@type":"ImageObject","url":"https://lorenwe.eu.org/img/favicon.ico"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lorenwe.eu.org/ accesskey=h title="Lorenwe Blog (Alt + H)"><img src=https://lorenwe.eu.org/img/kaola.png alt=logo aria-label=logo height=35>Lorenwe Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://lorenwe.eu.org/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://lorenwe.eu.org/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://lorenwe.eu.org/posts title="📚 文章"><span>📚 文章</span></a></li><li><a href=https://lorenwe.eu.org/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://lorenwe.eu.org/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li><li><a href=https://lorenwe.eu.org/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://lorenwe.eu.org/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://lorenwe.eu.org/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://lorenwe.eu.org/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://lorenwe.eu.org/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>PHP构造multipart/form-data格式POST请求体的方法</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2024-09-25
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>2403字
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>5分钟
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>Lorenwe
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://lorenwe.eu.org/tags/php/ style=color:var(--secondary)!important>PHP</a>
&nbsp;<a href=https://lorenwe.eu.org/tags/post/ style=color:var(--secondary)!important>POST</a>
&nbsp;<a href=https://lorenwe.eu.org/tags/http/ style=color:var(--secondary)!important>HTTP</a></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=引言>引言</a></li><li><a href=#multipartform-data-%e6%a0%bc%e5%bc%8f aria-label="multipart/form-data 格式">multipart/form-data 格式</a></li><li><a href=#%e8%bf%98%e5%8e%9f-multipartform-data-%e7%9a%84%e4%bb%a3%e7%a0%81 aria-label="还原 multipart/form-data 的代码">还原 multipart/form-data 的代码</a></li><li><a href=#%e6%95%b0%e7%bb%84%e7%b1%bb%e5%9e%8b%e5%8f%82%e6%95%b0%e7%9a%84%e6%94%af%e6%8c%81 aria-label=数组类型参数的支持>数组类型参数的支持</a></li><li><a href=#getformdata-%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0 aria-label="getFormData() 代码实现">getFormData() 代码实现</a></li><li><a href=#php%e4%b8%ad%e4%bb%a5multipartform-data%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e6%b5%81 aria-label=PHP中以multipart/form-data上传文件流>PHP中以multipart/form-data上传文件流</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h3 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h3><p>最近在尝试基于 PHP 做一个反向代理 HTTP 的程序，其中一个需求是将程序收到的HTTP请求还原回 <a href=https://www.ietf.org/rfc/rfc2616.txt>RFC2616</a> 的原始格式。</p><p>在处理的过程中遇到的问题主要在请求体的处理上。利用PHP的封装协议机制，我们可以通过读取 <a href=https://www.php.net/manual/zh/wrappers.php.php>php://input</a> 访问原始的POST信息。但这种方式有一个局限，对于 multipart/form-data 的请求来说，为了支持文件上传的操作，PHP会预先把请求体中的文件暂存到临时文件夹，并把参数解析到变量 $_POST 和 $_FILES 中， php://input 获取原始请求的功能也随之失效。</p><p>Stack Overflow 上的相关问题给出的 解决办法 是修改服务器配置，把发到 PHP 脚本的 Content-Type: multipart/form-data; boundary=xxxx 修改为其它格式，使其不经过PHP的 form-data 解析；或是把 php.ini 配置关于POST数据解析的 <a href=https://www.php.net/manual/en/ini.core.php#ini.enable-post-data-reading>enable_post_data_reading = Off</a> 选项关闭。然而这两种方法并不非常具有普遍性，在某些PHP配置文件不可控的共享主机的环境下并不适用。</p><p>于是引出了本文讨论的话题 — 如何重新组装 multipart/form-data 格式的原始 POST 请求体。</p><h3 id=multipartform-data-格式>multipart/form-data 格式<a hidden class=anchor aria-hidden=true href=#multipartform-data-格式>#</a></h3><p>在POST请求中，一般表单会通过 application/x-www-form-urlencoded 格式上传，但此格式的数据仅支持文本格式，不支持二进制文件的上传。为了支持表单 POST 文件上传，<a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a> 定义了 multipart/form-data 的数据格式，实现了通过POST请求上传表单的内容以及二进制文件数据，关于数据的形态，参考 四种常见的 POST 提交数据方式 | JerryQu 的小站 。</p><p><a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a> 对于 multipart/form-data 的数据格式主要在MIME <a href=https://www.ietf.org/rfc/rfc1521.txt>RFC1521</a> 7.2.1 小节定义的。另外，在MIME 标准 Media Types 部分 <a href=https://www.ietf.org/rfc/rfc2046.txt>RFC2046</a> 的 5.1.1 节中，对于 multipart-body 的格式有一个较为清晰的 BNF 范式的语法定义，简短总结如下（来自 <a href=https://stackoverflow.com/questions/27993445/is-this-a-well-formed-multipart-form-data-request>Stack Overflow</a>） ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>multipart-body := [preamble CRLF]
</span></span><span style=display:flex><span>                  dash-boundary CRLF
</span></span><span style=display:flex><span>                  body-part *encapsulation
</span></span><span style=display:flex><span>                  close-delimiter
</span></span><span style=display:flex><span>                  [CRLF epilogue]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dash-boundary := &#34;--&#34; boundary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>body-part := MIME-part-headers [CRLF *OCTET]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>encapsulation := delimiter
</span></span><span style=display:flex><span>                 CRLF body-part
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delimiter := CRLF dash-boundary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>close-delimiter := delimiter &#34;--&#34;
</span></span></code></pre></div><h3 id=还原-multipartform-data-的代码>还原 multipart/form-data 的代码<a hidden class=anchor aria-hidden=true href=#还原-multipartform-data-的代码>#</a></h3><p>写代码前搜索前人的经验，在 SegmentFault 看到了一位<a href=https://segmentfault.com/q/1010000002604013>前辈的实现</a>，参考前辈的代码，以及 RFC2046 的 BNF 语法定义，写了以下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// 还原 rfc1867, rfc2046 格式的FormData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getFormData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// body-part array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $body <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 普通参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>foreach</span> ($_POST <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$value<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // 上传文件处理
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  foreach (</span><span style=color:#e6db74>$_FILES</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$key</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span>; <span style=color:#a6e22e>filename</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;type&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>]);
</span></span><span style=display:flex><span>    $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 提取boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $boundary <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;=&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// multipart-body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 拼接各个域
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>, $body);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 最后一个不同的 boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary</span><span style=color:#e6db74>--&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $multipart_body;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=数组类型参数的支持>数组类型参数的支持<a hidden class=anchor aria-hidden=true href=#数组类型参数的支持>#</a></h3><p>以上代码在大多数情况下工作正常，但未考虑到请求参数的类型为数组的情况。</p><p>在PHP解释器源码的测试用例中，我们可以找到许多数组类型参数的测试，部分摘录如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>a[]=1
</span></span><span style=display:flex><span>a[]=1&amp;a[]=1
</span></span><span style=display:flex><span>a[]=1&amp;a[0]=5
</span></span><span style=display:flex><span>a[a]=1&amp;a[b]=3
</span></span><span style=display:flex><span>a[]=1&amp;a[a]=1&amp;a[b]=3
</span></span><span style=display:flex><span>a[][]=1&amp;a[][]=3&amp;b[a][b][c]=1&amp;b[a][b][d]=1
</span></span><span style=display:flex><span>a=1&amp;b=ZYX&amp;c[][][][][][][][][][][][][][][][][][][][][][]=123&amp;d=123&amp;e[][]][]=3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Content-Type: multipart/form-data; boundary=---------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[]&#34;; filename=&#34;file1.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[2]&#34;; filename=&#34;file2.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file[]&#34;; filename=&#34;file3.txt&#34;
</span></span><span style=display:flex><span>Content-Type: text/plain-file3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3
</span></span><span style=display:flex><span>-----------------------------20896060251896012921717172737--
</span></span></code></pre></div><p>在PHP源码的 main/php_variables.c 中的 php_register_variable_ex 函数中，我们可以看到相关的处理：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* 99-110行 */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ensure that we don&#39;t have spaces or dots in the variable name (not binary safe) */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (p <span style=color:#f92672>=</span> var; <span style=color:#f92672>*</span>p; p<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> <span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;.&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;_&#39;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>p <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;[&#39;</span>) {
</span></span><span style=display:flex><span>        is_array <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        ip <span style=color:#f92672>=</span> p;
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>var_len <span style=color:#f92672>=</span> p <span style=color:#f92672>-</span> var;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 229-235行 */</span>
</span></span><span style=display:flex><span>ip<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>ip <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;[&#39;</span>) {
</span></span><span style=display:flex><span>    is_array <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>ip <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> plain_var;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可见，在还原POST数据的时候，我们还需要考虑到参数为数组的情况。</p><p>这里通过一个简单的 DFS 算法深度优先遍历数组，生成类似 a[0], a[1][1] 的字符串来实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$arr <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;key1&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;_key1&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>23333</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;_key2&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>66666</span>,
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;key2&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;hahah&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var_dump</span>($arr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dfs</span>(<span style=color:#f92672>&amp;</span>$node, $prefix, <span style=color:#f92672>&amp;</span>$result) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($node)) {
</span></span><span style=display:flex><span>    $result[$prefix] <span style=color:#f92672>=</span> $node;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($node <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dfs</span>($value, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>[</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>, $result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dfs</span>($arr, <span style=color:#e6db74>&#34;arr&#34;</span>, $result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($result <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key</span><span style=color:#e6db74> = </span><span style=color:#e6db74>$value\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>运行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>array(3) {
</span></span><span style=display:flex><span>  [&#34;key1&#34;]=&gt;
</span></span><span style=display:flex><span>  array(2) {
</span></span><span style=display:flex><span>    [&#34;_key1&#34;]=&gt;
</span></span><span style=display:flex><span>    int(23333)
</span></span><span style=display:flex><span>    [&#34;_key2&#34;]=&gt;
</span></span><span style=display:flex><span>    int(66666)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  [&#34;key2&#34;]=&gt;
</span></span><span style=display:flex><span>  string(5) &#34;hahah&#34;
</span></span><span style=display:flex><span>  [0]=&gt;
</span></span><span style=display:flex><span>  string(4) &#34;test&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>arr[key1][_key1] = 23333
</span></span><span style=display:flex><span>arr[key1][_key2] = 66666
</span></span><span style=display:flex><span>arr[key2] = hahah
</span></span><span style=display:flex><span>arr[0] = test
</span></span></code></pre></div><p>至于 $_FILES 数组，这里有一个反直觉的情况，具体在文档中也有人提出： <a href=http://php.net/manual/en/features.file-upload.post-method.php#91479>PHP: POST method uploads - Manual</a></p><p>简单地说，当表单中文件域的key为数组形式时，拿到的 $_FILES 数组类似如下的格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>array(1) {
</span></span><span style=display:flex><span>  [&#34;key&#34;]=&gt;
</span></span><span style=display:flex><span>  array(5) {
</span></span><span style=display:flex><span>    [&#34;name&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(8) &#34;test.txt&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(8) &#34;test.txt&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;type&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(10) &#34;text/plain&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(10) &#34;text/plain&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;tmp_name&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      string(14) &#34;/tmp/phpKHCoSt&#34;
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        string(14) &#34;/tmp/phpSgtRHe&#34;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;error&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      int(0)
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        int(0)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    [&#34;size&#34;]=&gt;
</span></span><span style=display:flex><span>    array(2) {
</span></span><span style=display:flex><span>      [0]=&gt;
</span></span><span style=display:flex><span>      int(8)
</span></span><span style=display:flex><span>      [1]=&gt;
</span></span><span style=display:flex><span>      array(1) {
</span></span><span style=display:flex><span>        [0]=&gt;
</span></span><span style=display:flex><span>        int(8)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>假设我的目标是 key[1][0] 的 name 属性，在PHP中我们需要通过 $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;][1][0] 来访问，而在 $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;] 中，后面的索引的层级并不确定的，我们也不能简单地指定 [1][0] 来访问 $_FILES[&ldquo;key&rdquo;][&ldquo;name&rdquo;][1][0]。所以这里得有一些 hack 来优化一下这个过程，这里我实现了一个 query_multidimensional_array 函数，具体看最终的代码。</p><h3 id=getformdata-代码实现>getFormData() 代码实现<a hidden class=anchor aria-hidden=true href=#getformdata-代码实现>#</a></h3><p>以下是整个函数的完整实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>// 还原 rfc1867, rfc2046 格式的FormData
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getFormData</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// body-part array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $body <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 普通参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>foreach</span> ($_POST <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($value)) {
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$value<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    } else {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      // 数组的情况处理 如 param1[]=xxxx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$result</span><span style=color:#e6db74> = array();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      convert_array_key(</span><span style=color:#e6db74>$value</span><span style=color:#e6db74>, </span><span style=color:#e6db74>$key</span><span style=color:#e6db74>, </span><span style=color:#e6db74>$result</span><span style=color:#e6db74>);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      foreach (</span><span style=color:#e6db74>$result</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$k</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$v</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$k\</span><span style=color:#e6db74>&#34;</span><span style=color:#a6e22e>\r\n</span><span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> .= &#34;</span><span style=color:#a6e22e>\r\n</span>$v<span style=color:#e6db74>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span><span style=color:#e6db74>$body</span><span style=color:#e6db74>[] = </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // 上传文件处理
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  foreach (</span><span style=color:#e6db74>$_FILES</span><span style=color:#e6db74> as </span><span style=color:#e6db74>$key</span><span style=color:#e6db74> =&gt; </span><span style=color:#e6db74>$value</span><span style=color:#e6db74>) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if (!is_array(</span><span style=color:#e6db74>$value[&#39;type&#39;]</span><span style=color:#e6db74>)) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span><span style=color:#e6db74>$body_part</span><span style=color:#e6db74> = &#34;</span><span style=color:#a6e22e>Content</span><span style=color:#f92672>-</span><span style=color:#a6e22e>Disposition</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>form</span><span style=color:#f92672>-</span><span style=color:#a6e22e>data</span>; <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$key\</span><span style=color:#e6db74>&#34;</span>; <span style=color:#a6e22e>filename</span><span style=color:#f92672>=</span><span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$value[<span style=color:#e6db74>&#39;type&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>      $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>]);
</span></span><span style=display:flex><span>      $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 文件key是数组的情况 如 file1[]=xxxx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      $result <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>convert_array_key</span>($value[<span style=color:#e6db74>&#39;type&#39;</span>], <span style=color:#e6db74>&#34;&#34;</span>, $result);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>foreach</span> ($result <span style=color:#66d9ef>as</span> $k <span style=color:#f92672>=&gt;</span> $v) {
</span></span><span style=display:flex><span>        $filename <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;name&#39;</span>], $k);
</span></span><span style=display:flex><span>        $type <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;type&#39;</span>], $k);
</span></span><span style=display:flex><span>        $tmp_name <span style=color:#f92672>=</span> <span style=color:#a6e22e>query_multidimensional_array</span>($value[<span style=color:#e6db74>&#39;tmp_name&#39;</span>], $k);
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Content-Disposition: form-data; name=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}{</span>$k<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>; filename=</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{</span>$filename<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;Content-type: </span><span style=color:#e6db74>{</span>$type<span style=color:#e6db74>}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $body_part <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>file_get_contents</span>($tmp_name);
</span></span><span style=display:flex><span>        $body[] <span style=color:#f92672>=</span> $body_part;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 提取boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $boundary <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;=&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// multipart-body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 拼接各个域
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary\r\n</span><span style=color:#e6db74>&#34;</span>, $body);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 最后一个不同的 boundary
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  $multipart_body <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>--</span><span style=color:#e6db74>$boundary</span><span style=color:#e6db74>--&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $multipart_body;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 直接访问多维数组元素
</span></span></span><span style=display:flex><span><span style=color:#75715e>// query: [0][0] -&gt; $array[0][0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>query_multidimensional_array</span>(<span style=color:#f92672>&amp;</span>$array, $query) {
</span></span><span style=display:flex><span>  $query <span style=color:#f92672>=</span> <span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#39;][&#39;</span>, <span style=color:#a6e22e>substr</span>($query, <span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>  $temp <span style=color:#f92672>=</span> $array;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>foreach</span> ($query <span style=color:#66d9ef>as</span> $key) {
</span></span><span style=display:flex><span>    $temp <span style=color:#f92672>=</span> $temp[$key];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> $temp;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DFS将数组变为一维形式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>convert_array_key</span>(<span style=color:#f92672>&amp;</span>$node, $prefix, <span style=color:#f92672>&amp;</span>$result) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($node)) {
</span></span><span style=display:flex><span>    $result[$prefix] <span style=color:#f92672>=</span> $node;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> ($node <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>convert_array_key</span>($value, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>$prefix<span style=color:#e6db74>}</span><span style=color:#e6db74>[</span><span style=color:#e6db74>{</span>$key<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>, $result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>至此，在PHP脚本中，只需调用 getFormData() ，即可获得 multipart/form-data 请求的原始数据，通过以下代码可以实现一键获取请求原始POST Body。</p><p>需要注意的是，若数组类型参数是 a[] 这种形式，经过本函数还原后会补充具体的下标，比如说这里的 a[] 会被处理成 a[0] ，a[][] 则为 a[0][0]。从而导致了 POST Body 长度发生变化，若结果需要用于发包等操作，我们需要重新计算 Content-Length ，避免请求出现问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>@</span>$_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>] <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>strpos</span>($_SERVER[<span style=color:#e6db74>&#39;CONTENT_TYPE&#39;</span>], <span style=color:#e6db74>&#34;multipart/form-data&#34;</span>) <span style=color:#f92672>!==</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>  $body <span style=color:#f92672>=</span> <span style=color:#a6e22e>getFormData</span>();
</span></span><span style=display:flex><span>  $content_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>($body);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  $body <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#39;php://input&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=php中以multipartform-data上传文件流>PHP中以multipart/form-data上传文件流<a hidden class=anchor aria-hidden=true href=#php中以multipartform-data上传文件流>#</a></h3><p>上传类:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UploadPart</span>
</span></span><span style=display:flex><span>{   
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $url;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $delimiter;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> $instance;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;上传地址&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>=</span> <span style=color:#a6e22e>uniqid</span>(); <span style=color:#75715e>// 生成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>putPart</span>($param) {
</span></span><span style=display:flex><span>        $post_data <span style=color:#f92672>=</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span><span style=color:#a6e22e>buildData</span>($param);
</span></span><span style=display:flex><span>        $curl <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_init</span>(<span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$url);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_RETURNTRANSFER</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_POST</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_POSTFIELDS</span>, $post_data);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_setopt</span>($curl, <span style=color:#a6e22e>CURLOPT_HTTPHEADER</span>, [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Type: multipart/form-data; boundary=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Content-Length: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>strlen</span>($post_data)
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>        $response <span style=color:#f92672>=</span> <span style=color:#a6e22e>curl_exec</span>($curl);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>curl_close</span>($curl);
</span></span><span style=display:flex><span>        $info <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_decode</span>($response, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_array</span>($info[<span style=color:#e6db74>&#39;Msg&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> $info[<span style=color:#e6db74>&#39;Msg&#39;</span>] <span style=color:#f92672>==</span> $param[<span style=color:#e6db74>&#39;filesize&#39;</span>]) {
</span></span><span style=display:flex><span>            $param[<span style=color:#e6db74>&#39;offset&#39;</span>] <span style=color:#f92672>=</span> $param[<span style=color:#e6db74>&#39;filesize&#39;</span>];
</span></span><span style=display:flex><span>            $param[<span style=color:#e6db74>&#39;upload&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>putPart</span>($param);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $response;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>buildData</span>($param){
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>        $eol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $upload <span style=color:#f92672>=</span> $param[<span style=color:#e6db74>&#39;upload&#39;</span>];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unset</span>($param[<span style=color:#e6db74>&#39;upload&#39;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> ($param <span style=color:#66d9ef>as</span> $name <span style=color:#f92672>=&gt;</span> $content) {
</span></span><span style=display:flex><span>            $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Disposition: form-data; name=&#34;&#39;</span> <span style=color:#f92672>.</span> $name <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;\r\n\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span> $content <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 拼接文件流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> $eol
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Disposition: form-data; name=&#34;upload&#34;; filename=&#34;&#39;</span> <span style=color:#f92672>.</span> $param[<span style=color:#e6db74>&#39;filename&#39;</span>] <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;&#34;&#39;</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;Content-Type:application/octet-stream&#39;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>.=</span> $upload <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        $data <span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;--&#34;</span> <span style=color:#f92672>.</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$delimiter <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;--</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $data;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getInstance</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>static</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>static</span><span style=color:#f92672>::</span>$instance;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$fields <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;video&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filename&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1407.png&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filesize&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>58701</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;offset&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;filetype&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;.acc&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;originName&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;1407.png&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;upload&#39;</span><span style=color:#f92672>=&gt;</span><span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#39;0407.png&#39;</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>$part <span style=color:#f92672>=</span> <span style=color:#a6e22e>UploadPart</span><span style=color:#f92672>::</span><span style=color:#a6e22e>getInstance</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>putPart</span>($fields);
</span></span></code></pre></div><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><ul><li><a href=https://www.ietf.org/rfc/rfc1521.txt>RFC1521</a></li><li><a href=https://www.ietf.org/rfc/rfc1867.txt>RFC1867</a></li><li><a href=https://www.ietf.org/rfc/rfc2046.txt>RFC2046</a></li><li><a href=https://www.php.net/manual/zh/features.file-upload.post-method.php>PHP: POST 方法上传 - Manual</a></li><li><a href=https://www.php.net/manual/zh/features.file-upload.multiple.php>PHP: 上传多个文件 - Manual</a></li><li><a href=https://www.laruence.com/2009/09/26/1103.html>PHP文件上传源码分析(RFC1867) | 风雪之隅</a></li><li><a href=https://www.laruence.com/2008/11/07/586.html>深入理解PHP原理之文件上传 | 风雪之隅</a></li><li><a href=https://imququ.com/post/four-ways-to-post-data-in-http.html>四种常见的 POST 提交数据方式 | JerryQu 的小站</a></li><li><a href=https://stackoverflow.com/questions/1361673/get-raw-post-data>php - Get raw post data - Stack Overflow</a></li><li><a href=https://stackoverflow.com/questions/27993445/is-this-a-well-formed-multipart-form-data-request>http - Is this a well formed multipart/form-data request? - Stack Overflow</a></li><li><a href=https://segmentfault.com/q/1010000002604013>http - 请问哪份 RFC 文档定义了 multipart/form-data 的格式？ - SegmentFault 思否</a></li></ul></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://lorenwe.eu.org/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://lorenwe.eu.org/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://lorenwe.eu.org/posts/tech/%E5%9B%9B%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84post%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E6%96%B9%E5%BC%8F/><span class=title>« 上一页</span><br><span>四种常见的POST提交数据方式</span>
</a><a class=next href=https://lorenwe.eu.org/posts/tech/win10%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AAgithub%E8%B4%A6%E5%8F%B7/><span class=title>下一页 »</span><br><span>Win10配置多个Github账号</span></a></nav></footer></div><div id=giscus-comment></div><script>function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");if(!t||!t.contentWindow)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}function createGusicScript(){const t=document.querySelector("#giscus-comment"),n=localStorage.getItem("pref-theme");let e=document.createElement("script");e.src="https://giscus.app/client.js",e.setAttribute("data-repo","lorenwe/lorenwe.github.io"),e.setAttribute("data-repo-id","MDEwOlJlcG9zaXRvcnk3NDY0NzM4MQ=="),e.setAttribute("data-category","Announcements"),e.setAttribute("data-category-id","DIC_kwDOBHMHVc4CizTN"),e.setAttribute("data-mapping","title"),e.setAttribute("data-strict","0"),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",n),e.setAttribute("data-lang","zh-CN"),e.setAttribute("data-loading","lazy"),e.setAttribute("crossorigin","anonymous"),e.async=!0,t&&t.appendChild(e)}createGusicScript()</script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
<span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),sendMessage({setConfig:{theme:"light"}})):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),sendMessage({setConfig:{theme:"dark"}}))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`\r

————————————————\r
版权声明：本文为「Lorenwe Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。\r
原文链接：`+location.href,s=window.getSelection().toString()+`\r

————————————————\r
版权声明：本文为「Lorenwe Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。\r
原文链接：`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`\r
————————————————\r
版权声明：本文为「Lorenwe Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。\r
原文链接：`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>